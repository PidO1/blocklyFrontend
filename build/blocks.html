<html>

<head>
  <title>Parcel Sandbox</title>
  <meta charset="UTF-8" />
</head>

<body>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
    rel="stylesheet">
  <style>
    body {
      background: rgb(46, 46, 46);
      color: #fff;
      display: grid;
      min-height: 100vh;
      min-width: 100vw;
      grid-template-columns: 16px 1fr 16px;
      grid-template-rows: 16px 1fr auto 16px;
      padding: 0;
      margin: 0;
      gap: 8px;
      grid-template-areas:
        ". . ."
        ". code ."
        ". buttons ."
        ". . .";
    }

    .code {
      grid-area: code;
    }

    .buttons {
      grid-area: buttons;
      display: flex;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 0.25rem;
      background-color: #454545;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      padding: 0rem 1rem;
      min-height: 2.25rem;
      min-width: 4rem;
      transition: 0.6s;
      border: solid 1px transparent;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    button:hover {
      background-color: hsla(0, 0%, 100%, 0.2);
      box-shadow: -0.0625rem 0.5rem 1.5rem 0.5rem hsla(0, 0%, 0%, 0.1);
      border-radius: 0.5rem;
      border: solid 1px #1de9b6;
    }

    button:active {
      background-color: hsla(0, 0%, 100%, 0.3);
      box-shadow: none;
    }

    button .button-icon {
      padding-left: 0.5rem;
      width: 1.5rem;
      height: 1.5rem;
    }

    button.icon-button {
      padding-left: 0.05rem;
      padding-right: 1rem;
    }

    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      /* Preferred icon size */
      display: inline-block;
      line-height: 1;
      text-transform: none;
      letter-spacing: normal;
      word-wrap: normal;
      white-space: nowrap;
      direction: ltr;

      /* Support for all WebKit browsers. */
      -webkit-font-smoothing: antialiased;
      /* Support for Safari and Chrome. */
      text-rendering: optimizeLegibility;

      /* Support for Firefox. */
      -moz-osx-font-smoothing: grayscale;

      /* Support for IE. */
      font-feature-settings: 'liga';
    }

    pre {
      margin: 0;
      padding: 16px;
      padding: 16px;
      border-top: inherit;
    }

    pre,
    code {
      background-color: transparent;
    }

    code {
      font-family: 'JetBrains Mono',
        monospace;
      font-variant-ligatures: normal;
      font-size: 13px;
    }

    #blocklyDiv * {
      background-color: transparent;
    }

    .blocklyFlyoutBackground {
      fill: rgb(53, 53, 53);
      fill-opacity: unset;
    }

    .blocklyMainBackground {
      stroke: none;
    }
  </style>
  <!-- <div id="app"></div> -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/browse/blockly@5.20210325.1/blockly_compressed.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <div class="code"
    style=" border-radius: 8px; border: solid 1px hsla(0, 0%, 100%, 0.3); display: grid; grid-template-rows: 1fr 1fr auto;">
    <div id="blocklyDiv"></div>
    <pre>
      <code id='textarea'></code>
    </pre>
    <xml id="toolbox" style="display: none;">
      <block type="controls_if"></block>
      <block type="controls_repeat_ext"></block>
      <block type="logic_compare"></block>
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="text"></block>
      <block type="text_print"></block>
      <block type="logic_boolean"></block>
      <block type="controls_ifelse"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
      <!-- <block type="controls_repeat"></block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for"></block>
        <block type="controls_forEach"></block>
        <block type="controls_flow_statements"></block> -->
      <block type="variables_get"></block>
      <block type="lists_create_empty"></block>
      <block type="lists_repeat"></block>
      <block type="lists_reverse"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_length"></block>
      <!-- <block type="variables_get_dynamic"></block>
        <block type="variables_set_dynamic"></block> -->
      <block type="text_multiline"></block>
      <block type="text_join"></block>
      <block type="text_create_join_container"></block>
      <block type="text_create_join_item"></block>
      <block type="text_append"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf"></block>
      <block type="text_charAt"></block>
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb"></block>
      <block type="colour_blend"></block>
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_change"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_constrain"></block>
      <block type="math_random_int"></block>
      <block type="math_random_float"></block>
      <block type="math_atan2"></block>
    </xml>
  </div>
  <div class="buttons">
    <button id='downloadBtn' type="submit" class="icon-button">
      <i class="button-icon material-icons">
        file_download
      </i>
      Download
    </button>
    <button id='saveBtn' type="submit" class="icon-button">
      <i class="button-icon material-icons">
        save
      </i>
      Save
    </button>
  </div>
  <script>
    function getUserFromCookie() {
      if (document.cookie)
        cookie = document.cookie.split('; ')
        .find(row => {
          if (row.indexOf('token=') > -1)
            return row.split('=')[1];
        });
      return cookie;
    }

    if (!getUserFromCookie()) {
      window.history.go(-1);
    }

    var workspace = Blockly.inject("blocklyDiv", {
      toolbox: document.getElementById("toolbox"),
      move: {
        scrollbars: {
          horizontal: true,
          vertical: true
        },
        drag: true,
        wheel: false
      },
      grid: {
        spacing: 32,
        length: 2,
        colour: '#fafafa',
        snap: true
      },
      zoom: {
        controls: true,
        wheel: false,
        startScale: 1.0,
        maxScale: 10,
        minScale: 0.3,
        scaleSpeed: 1.2,
        pinch: true
      },
      trashcan: true
    });
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    workspace.addChangeListener(() => {
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      document.getElementById('textarea').innerHTML = '<br/>' + code;
    });

    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    // Start file download.
    document.getElementById("downloadBtn").addEventListener("click", function () {
      var text = document.getElementById("textarea").innerText;
      var filename = "blockly.js";

      download(filename, text);
    }, false);

    document.getElementById("saveBtn").addEventListener("click", function () {
      var text = document.getElementById("textarea").innerText;
      var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
      const params = {
        headers: {
          'content-type': 'application/json; charset=UTF-8',
          'jwt_token': getUserFromCookie().split('=')[1]
        },
        body: JSON.stringify({
          "xml": `${Blockly.Xml.domToText(xml)}`,
          "token": getUserFromCookie().split('=')[1],
        }),
        method: 'POST'
      };
      return fetch('https://bbd-levelup-backend.herokuapp.com/users/save/project', params).then((r) => alert(
        'Project Saved'));
    }, false);
  </script>
</body>

</html>